<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DomUnify Test Suite</title>
  <style>
    body { font-family: sans-serif; }
    #root { padding: 10px; border: 1px solid #ccc; margin-bottom: 20px; }
    button { margin: 2px; }
    .error { background: #ffe0e0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="buttons"></div>

  <script type="module">
    import { dom } from './index.js'

    const root = document.getElementById('root')

    const clearRoot = () => root.innerHTML = ''

    const tests = [
      // 1. Добавление одного элемента
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'box', text: 'test 1' })
        if (!root.querySelector('.box')) throw new Error('Элемент .box не добавлен')
      },

      // 2. Добавление массива элементов
      () => {
        clearRoot()
        dom(root).add([{ tag: 'div', text: 'A' }, { tag: 'div', text: 'B' }])
        if (root.querySelectorAll('div').length !== 2) throw new Error('Добавлено не 2 div')
      },

      // 3. Вложенные дети
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'parent', children: [{ tag: 'span', text: 'child' }] })
        const span = root.querySelector('span')
        if (!span || span.textContent !== 'child') throw new Error('Вложенный span не найден или текст неверен')
      },

      // 4. set() - обновление текста и класса
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'set-test', text: 'old' })
        dom(root).enter().set({ text: 'new', class: 'set-test updated' })
        const el = root.querySelector('.set-test.updated')
        if (!el || el.textContent !== 'new') throw new Error('set() не сработал')
      },

      // 5. copy() и paste()
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'copy-me', text: 'copy' })
        dom(root).enter().copy().paste()
        if (root.querySelectorAll('.copy-me').length !== 2) throw new Error('copy/paste не сработал')
      },

      // 6. paste() с 'prepend'
      () => {
        clearRoot()
        dom(root)
          .add({ tag: 'div', class: 'prepend-test', text: 'prepend' })
          .enter()
          .copy()
          .back()
          .paste()
          .paste()
          .paste()
          .paste()
          .find('*')
          .add({ tag: 'span', class: 'prepend-test', text: 'prepend' })

        // if (root.firstElementChild.textContent !== 'prepend') throw new Error('paste(prepend) не работает')
      },

      // 7. paste() с индексом 0
      () => {
        clearRoot()
        dom(root).add([{ tag: 'div', text: 'A' }, { tag: 'div', text: 'B' }])
        const du = dom(root).enter(1) // входим во второй div с текстом B
        du.copy()
        du.currentElements = [root]
        du.paste(0)
        if (root.firstElementChild.textContent !== 'B') throw new Error('paste(0) не работает')
      },

      // 8. duplicate() append
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'dup-test', text: 'dup' })
        dom(root).enter().duplicate()
        if (root.querySelectorAll('.dup-test').length !== 2) throw new Error('duplicate() append не сработал')
      },

      // 9. duplicate() prepend
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'dup-prepend', text: 'dup' })
        dom(root).enter().duplicate('prepend')
        if (root.firstElementChild.className !== 'dup-prepend') throw new Error('duplicate(prepend) не сработал')
      },

      // 10. enter() и back() с индексом
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'enter-test', children: [{ tag: 'span', text: 'inside' }] })
        dom(root).enter(0).enter(0)
        if (dom(root).currentElements.length !== 1) throw new Error('enter() не сработал')
        dom(root).enter(0).back()
        if (dom(root).currentElements.length === 0) throw new Error('back() не сработал')
      },

      // 11. back() с селектором
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'wrapper', children: [{ tag: 'div', class: 'child' }] })
        dom(root).enter(0).enter(0).back('.wrapper')
        if (!dom(root).currentElements[0].classList.contains('wrapper')) throw new Error('back(selector) не сработал')
      },

      // 12. delete()
      () => {
        clearRoot()
        dom(root).add({ tag: 'div', class: 'to-delete' })
        dom(root).enter(0).delete()
        if (root.querySelector('.to-delete')) throw new Error('delete() не удалил элемент')
      }
    ]

    const buttons = document.getElementById('buttons')

    tests.forEach((fn, i) => {
      const btn = document.createElement('button')
      btn.textContent = `Test ${i + 1}`
      btn.onclick = () => {
        try {
          fn()
          btn.classList.remove('error')
          console.log(`Test ${i + 1} passed`)
        } catch (e) {
          btn.classList.add('error')
          console.error(`Test ${i + 1} failed:`, e.message)
        }
      }
      buttons.appendChild(btn)
    })
  </script>
</body>
</html>
